<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semantic Product Search - AI-Powered Recommendations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .skeleton {
            animation: shimmer 2s infinite linear;
            background: linear-gradient(to right, #f0f0f0 4%, #e0e0e0 25%, #f0f0f0 36%);
            background-size: 1000px 100%;
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
        }
        .product-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-purple-50 min-h-screen">
    <div x-data="searchApp()" x-init="init()" class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-12">
            <div class="text-center mb-8">
                <h1 class="text-5xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-3">
                    <i class="fas fa-brain mr-2"></i>Semantic Product Search
                </h1>
                <p class="text-gray-600 text-lg">AI-powered recommendations using FAISS vector similarity</p>
                <div class="flex justify-center gap-4 mt-4 text-sm">
                    <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full">
                        <i class="fas fa-database mr-1"></i><span x-text="stats.total_products"></span> Products
                    </span>
                    <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full">
                        <i class="fas fa-bolt mr-1"></i><span x-text="stats.avg_latency"></span>ms Avg Latency
                    </span>
                    <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full">
                        <i class="fas fa-server mr-1"></i><span x-text="stats.status"></span>
                    </span>
                </div>
            </div>
        </header>

        <!-- Search Bar -->
        <div class="max-w-4xl mx-auto mb-12">
            <div class="glass-effect rounded-2xl shadow-2xl p-8">
                <form @submit.prevent="search()" class="space-y-4">
                    <div class="relative">
                        <input 
                            type="text" 
                            x-model="query"
                            @keyup.debounce.500ms="search()"
                            placeholder="Search for products... (e.g., 'wireless bluetooth headphones')"
                            class="w-full px-6 py-4 pr-32 text-lg border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all"
                        >
                        <button 
                            type="submit"
                            :disabled="loading || !query"
                            class="absolute right-2 top-2 px-6 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                        >
                            <i class="fas fa-search mr-2" x-show="!loading"></i>
                            <i class="fas fa-spinner fa-spin mr-2" x-show="loading"></i>
                            Search
                        </button>
                    </div>
                    
                    <!-- Filters -->
                    <div class="flex gap-4 flex-wrap">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                            <select 
                                x-model="filters.category"
                                @change="search()"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="">All Categories</option>
                                <option value="Electronics">Electronics</option>
                                <option value="Clothing">Clothing</option>
                                <option value="Books">Books</option>
                                <option value="Home & Garden">Home & Garden</option>
                                <option value="Sports">Sports</option>
                            </select>
                        </div>
                        
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Max Price</label>
                            <input 
                                type="number" 
                                x-model.number="filters.max_price"
                                @input.debounce.500ms="search()"
                                placeholder="Any"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                        </div>
                        
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Results</label>
                            <select 
                                x-model.number="topK"
                                @change="search()"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="5">5 results</option>
                                <option value="10">10 results</option>
                                <option value="20">20 results</option>
                                <option value="50">50 results</option>
                            </select>
                        </div>
                    </div>
                </form>
                
                <!-- Search Stats -->
                <div x-show="searchStats.latency" class="mt-4 text-sm text-gray-600 flex justify-between items-center">
                    <span>
                        Found <strong x-text="results.length"></strong> results in 
                        <strong x-text="searchStats.latency"></strong>ms
                        <span x-show="searchStats.correlation_id" class="ml-2 text-xs font-mono bg-gray-100 px-2 py-1 rounded">
                            ID: <span x-text="searchStats.correlation_id.slice(0, 8)"></span>
                        </span>
                    </span>
                    <button @click="clearSearch()" class="text-blue-600 hover:text-blue-800">
                        <i class="fas fa-times-circle mr-1"></i>Clear
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Skeleton -->
        <div x-show="loading" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <template x-for="i in topK" :key="i">
                <div class="bg-white rounded-xl shadow-lg p-6 skeleton">
                    <div class="h-48 bg-gray-300 rounded-lg mb-4"></div>
                    <div class="h-6 bg-gray-300 rounded mb-2"></div>
                    <div class="h-4 bg-gray-300 rounded mb-2"></div>
                    <div class="h-4 bg-gray-300 rounded w-3/4"></div>
                </div>
            </template>
        </div>

        <!-- Results -->
        <div x-show="!loading && results.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <template x-for="(product, index) in results" :key="product.product_id">
                <div 
                    class="product-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer"
                    @click="viewProduct(product)"
                    x-data="{ hover: false }"
                    @mouseenter="hover = true"
                    @mouseleave="hover = false"
                >
                    <!-- Score Badge -->
                    <div class="relative">
                        <div class="absolute top-4 right-4 z-10">
                            <div class="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-3 py-1 rounded-full text-sm font-bold shadow-lg">
                                <i class="fas fa-star mr-1"></i>
                                <span x-text="(product.score * 100).toFixed(0)"></span>% Match
                            </div>
                        </div>
                        
                        <!-- Placeholder Image -->
                        <div class="h-48 bg-gradient-to-br from-blue-100 to-purple-100 flex items-center justify-center">
                            <i class="fas fa-box-open text-6xl text-gray-400"></i>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <!-- Category Badge -->
                        <div class="mb-2">
                            <span class="inline-block px-2 py-1 text-xs font-semibold text-blue-600 bg-blue-100 rounded">
                                <span x-text="product.category"></span>
                            </span>
                        </div>
                        
                        <!-- Title -->
                        <h3 class="text-xl font-bold text-gray-800 mb-2 line-clamp-2" x-text="product.title"></h3>
                        
                        <!-- Description -->
                        <p class="text-gray-600 text-sm mb-4 line-clamp-3" x-text="product.description"></p>
                        
                        <!-- Footer -->
                        <div class="flex justify-between items-center">
                            <div class="text-2xl font-bold text-blue-600">
                                $<span x-text="product.price ? product.price.toFixed(2) : 'N/A'"></span>
                            </div>
                            <button 
                                @click.stop="findSimilar(product.product_id)"
                                class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors text-sm font-semibold"
                                :class="{ 'scale-110': hover }"
                            >
                                <i class="fas fa-search-plus mr-1"></i>Similar
                            </button>
                        </div>
                        
                        <!-- Product ID -->
                        <div class="mt-3 text-xs text-gray-400 font-mono">
                            ID: <span x-text="product.product_id"></span>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- No Results -->
        <div x-show="!loading && results.length === 0 && query" class="text-center py-16">
            <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-2xl font-semibold text-gray-600 mb-2">No results found</h3>
            <p class="text-gray-500">Try different keywords or clear filters</p>
        </div>

        <!-- Initial State -->
        <div x-show="!loading && results.length === 0 && !query" class="text-center py-16">
            <i class="fas fa-lightbulb text-6xl text-yellow-400 mb-4"></i>
            <h3 class="text-2xl font-semibold text-gray-600 mb-2">Start Searching</h3>
            <p class="text-gray-500 mb-6">Try searching for: "wireless headphones", "laptop", "running shoes"</p>
            <div class="flex justify-center gap-3 flex-wrap">
                <button 
                    @click="setQuery('wireless bluetooth headphones')"
                    class="px-6 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors"
                >
                    Wireless Headphones
                </button>
                <button 
                    @click="setQuery('laptop for programming')"
                    class="px-6 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors"
                >
                    Programming Laptop
                </button>
                <button 
                    @click="setQuery('running shoes')"
                    class="px-6 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors"
                >
                    Running Shoes
                </button>
            </div>
        </div>

        <!-- Product Detail Modal -->
        <div 
            x-show="selectedProduct" 
            @click.self="selectedProduct = null"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
            style="display: none;"
        >
            <div 
                class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
                @click.stop
                x-show="selectedProduct"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 transform scale-95"
                x-transition:enter-end="opacity-100 transform scale-100"
            >
                <div class="p-8" x-show="selectedProduct">
                    <div class="flex justify-between items-start mb-6">
                        <h2 class="text-3xl font-bold text-gray-800" x-text="selectedProduct?.title"></h2>
                        <button @click="selectedProduct = null" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <span class="inline-block px-3 py-1 text-sm font-semibold text-blue-600 bg-blue-100 rounded">
                                <span x-text="selectedProduct?.category"></span>
                            </span>
                        </div>
                        
                        <p class="text-gray-600 leading-relaxed" x-text="selectedProduct?.description"></p>
                        
                        <div class="flex items-center gap-4">
                            <div class="text-3xl font-bold text-blue-600">
                                $<span x-text="selectedProduct?.price?.toFixed(2)"></span>
                            </div>
                            <div class="px-3 py-1 bg-green-100 text-green-700 rounded-full font-semibold">
                                <i class="fas fa-star mr-1"></i>
                                <span x-text="(selectedProduct?.score * 100).toFixed(0)"></span>% Match
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t">
                            <button 
                                @click="findSimilar(selectedProduct?.product_id); selectedProduct = null"
                                class="w-full px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold"
                            >
                                <i class="fas fa-search-plus mr-2"></i>Find Similar Products
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Toast -->
        <div 
            x-show="error" 
            class="fixed bottom-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-2xl z-50 max-w-md"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 transform translate-y-4"
            x-transition:enter-end="opacity-100 transform translate-y-0"
        >
            <div class="flex items-start gap-3">
                <i class="fas fa-exclamation-circle text-2xl"></i>
                <div class="flex-1">
                    <h4 class="font-bold mb-1">Error</h4>
                    <p class="text-sm" x-text="error"></p>
                </div>
                <button @click="error = null" class="text-white hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        function searchApp() {
            return {
                query: '',
                topK: 10,
                filters: {
                    category: '',
                    max_price: null
                },
                results: [],
                loading: false,
                error: null,
                selectedProduct: null,
                stats: {
                    total_products: 0,
                    avg_latency: 0,
                    status: 'Loading...'
                },
                searchStats: {
                    latency: 0,
                    correlation_id: ''
                },
                apiBaseUrl: 'http://localhost:8080',
                
                async init() {
                    await this.loadStats();
                },
                
                async loadStats() {
                    try {
                        const response = await fetch(`${this.apiBaseUrl}/stats`);
                        if (response.ok) {
                            const data = await response.json();
                            this.stats.total_products = data.index_size || 0;
                            this.stats.status = data.ready ? 'Online' : 'Offline';
                        }
                    } catch (err) {
                        console.error('Failed to load stats:', err);
                        this.stats.status = 'Offline';
                    }
                },
                
                async search() {
                    if (!this.query.trim()) {
                        this.results = [];
                        return;
                    }
                    
                    this.loading = true;
                    this.error = null;
                    const startTime = performance.now();
                    
                    try {
                        const payload = {
                            query: this.query,
                            top_k: this.topK,
                            filters: {}
                        };
                        
                        if (this.filters.category) {
                            payload.filters.category = this.filters.category;
                        }
                        if (this.filters.max_price) {
                            payload.filters.max_price = this.filters.max_price;
                        }
                        
                        const response = await fetch(`${this.apiBaseUrl}/recommend`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(payload)
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const data = await response.json();
                        this.results = data.recommendations || [];
                        this.searchStats.latency = Math.round(performance.now() - startTime);
                        this.searchStats.correlation_id = data.correlation_id || '';
                        this.stats.avg_latency = this.searchStats.latency;
                        
                    } catch (err) {
                        console.error('Search failed:', err);
                        this.error = `Search failed: ${err.message}. Make sure the API is running at ${this.apiBaseUrl}`;
                        this.results = [];
                    } finally {
                        this.loading = false;
                    }
                },
                
                async findSimilar(productId) {
                    this.query = `Similar to ${productId}`;
                    this.loading = true;
                    this.error = null;
                    const startTime = performance.now();
                    
                    try {
                        const response = await fetch(
                            `${this.apiBaseUrl}/recommend/product/${productId}?top_k=${this.topK}`
                        );
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        
                        const data = await response.json();
                        this.results = data.recommendations || [];
                        this.searchStats.latency = Math.round(performance.now() - startTime);
                        this.searchStats.correlation_id = data.correlation_id || '';
                        
                    } catch (err) {
                        console.error('Similar search failed:', err);
                        this.error = `Failed to find similar products: ${err.message}`;
                    } finally {
                        this.loading = false;
                    }
                },
                
                viewProduct(product) {
                    this.selectedProduct = product;
                },
                
                setQuery(q) {
                    this.query = q;
                    this.search();
                },
                
                clearSearch() {
                    this.query = '';
                    this.results = [];
                    this.filters.category = '';
                    this.filters.max_price = null;
                    this.searchStats = { latency: 0, correlation_id: '' };
                }
            }
        }
    </script>
</body>
</html>